<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa Interactivo – Tendencia de Temperatura (CPC)</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body {
      height: 100vh;
      margin: 0; padding: 0;
      font-family: 'Segoe UI', Tahoma, sans-serif;
    }
    body {
      display: flex;
      flex-direction: column; /* menú, mapa, gráfica */
    }
    /* Menú */
    #menu {
      padding: 8px 12px;
      background: #f8f8f8;
      border-bottom: 1px solid #ddd;
    }
    #menu label {
      font-weight: bold;
      margin-right: 6px;
    }
    /* Mapa */
    #map {
      flex: 7;
      min-height: 300px;
    }
    /* Panel de gráfica */
    #chart-container {
      flex: 3;
      padding: 10px;
      background: #fff;
      border-top: 3px solid #007acc;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #chart-container h3 {
      margin: 0 0 8px;
      font-size: 1.1em;
    }
    #chart-container canvas {
      flex: 1;
    }
    /* Leyenda */
    .info.legend {
      background: white;
      padding: 6px 8px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      font-size: 12px;
    }
    .info.legend h4 {
      margin: 0 0 4px;
      font-size: 14px;
    }
    .gradient-bar {
      width: 200px;
      height: 10px;
      background: linear-gradient(to right,
        #3182bd 0%,   /* azul oscuro */
        #ffffff 50%,  /* blanco */
        #de2d26 100%  /* rojo oscuro */
      );
      margin-bottom: 4px;
    }
    .legend-labels {
      display: flex;
      justify-content: space-between;
      width: 200px;
    }
  </style>
</head>
<body>

  <div id="menu">
    <label for="variable-select">Variable:</label>
    <select id="variable-select">
      <option value="tmax">Temperatura Máxima</option>
      <option value="tmin">Temperatura Mínima</option>
    </select>
  </div>

  <div id="map"></div>

  <div id="chart-container">
    <h3 id="chart-title">Selecciona un estado</h3>
    <canvas id="chart"></canvas>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // ——————————————
    // 1) Inicializa el mapa y límites a México
    // ——————————————
    const mexicoBounds = [[14.5, -118.5], [32.7, -86.7]];
    const map = L.map('map', {
      maxBounds: mexicoBounds,
      maxBoundsViscosity: 1.0,
      minZoom: 5
    }).fitBounds(mexicoBounds);

    L.tileLayer(
      'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
      {
        attribution: '&copy; <a href="https://carto.com/">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
      }
    ).addTo(map);

    // ——————————————
    // 2) Escala continua azul→blanco→rojo
    // ——————————————
    const MIN_SLOPE = -0.05, MAX_SLOPE = 0.05;
    function getColor(d) {
      // Normaliza entre 0 y 1
      let t = Math.min(Math.max((d - MIN_SLOPE) / (MAX_SLOPE - MIN_SLOPE), 0), 1);
      if (t < 0.5) {
        // azul (#3182bd)→blanco
        const u = t / 0.5;
        return `rgb(
          ${Math.round(0x31 + u*(255-0x31))},
          ${Math.round(0x82 + u*(255-0x82))},
          ${Math.round(0xbd + u*(255-0xbd))}
        )`.replace(/\s+/g,'');
      } else {
        // blanco→rojo (#de2d26)
        const u = (t - 0.5)/0.5;
        return `rgb(
          ${Math.round(255 + u*(0xde-255))},
          ${Math.round(255 + u*(0x2d-255))},
          ${Math.round(255 + u*(0x26-255))}
        )`.replace(/\s+/g,'');
      }
    }

    // Hover & click
    function highlightFeature(e) {
      e.target.setStyle({ weight: 3, color: '#666', fillOpacity: 0.9 });
      e.target.bringToFront();
    }
    function resetHighlight(e) {
      geojsonLayer.resetStyle(e.target);
    }
    function zoomToFeature(e) {
      map.fitBounds(e.target.getBounds());
    }

    // ——————————————
    // 3) Prepara Chart.js
    // ——————————————
    const ctx = document.getElementById('chart').getContext('2d');
    let trendChart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [{
        label: '',
        data: [],
        borderColor: '#000',
        backgroundColor: 'rgba(0,0,0,0)',
        pointBackgroundColor: '#777',
        pointBorderColor: '#000',
        pointRadius: 5,
        tension: 0.3,
        fill: false
      }]},
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title:  { display: false },
          legend: { display: false },
          tooltip:{ callbacks: { label: ctx=>` ${ctx.parsed.y.toFixed(2)} °C` } }
        },
        scales: {
          x:{ title:{ display:true,text:'Año' }, grid:{color:'#f0f0f0'} },
          y:{ title:{ display:true,text:'Temperatura (°C)' }, grid:{color:'#f0f0f0'} }
        }
      }
    });

    // Variables globales
    let geojsonLayer = null, legendControl = null;

    // ——————————————
    // 4) Carga JSON y pinta mapa + leyenda
    // ——————————————
    function loadData(){
      const varp = document.getElementById('variable-select').value;  // "tmax"/"tmin"
      const file = `trends_cpc_${varp}.json`;

      if(geojsonLayer) map.removeLayer(geojsonLayer);
      if(legendControl) map.removeControl(legendControl);

      fetch(file)
        .then(r=>r.json())
        .then(data=>{
          geojsonLayer = L.geoJSON(data, {
            style:f=>({
              fillColor:   getColor(f.properties.slope),
              color:       'white',
              weight:      1,
              dashArray:   '3',
              fillOpacity: 0.7
            }),
            onEachFeature:(f,layer)=>{
              layer.bindPopup(
                `<strong>${f.properties.name}</strong><br>`+
                `Pendiente: ${f.properties.slope.toFixed(3)} °C/año`
              );
              layer.on({
                mouseover: highlightFeature,
                mouseout:  resetHighlight,
                click:     e=>{
                  zoomToFeature(e);
                  const s = f.properties.series;
                  trendChart.data.labels            = s.map(d=>d.year);
                  trendChart.data.datasets[0].data = s.map(d=>d.value);
                  trendChart.update();
                  document.getElementById('chart-title')
                          .textContent = f.properties.name;
                }
              });
            }
          }).addTo(map);

          // Restablece vista a México
          map.fitBounds(mexicoBounds);

          // Añade leyenda continua
          legendControl = L.control({position:'bottomright'});
          legendControl.onAdd = ()=>{
            const div = L.DomUtil.create('div','info legend');
            div.innerHTML = `
              <h4>Tendencia (°C/año)</h4>
              <div class="gradient-bar"></div>
              <div class="legend-labels">
                <span>${MIN_SLOPE}</span>
                <span>0</span>
                <span>${MAX_SLOPE}</span>
              </div>`;
            return div;
          };
          legendControl.addTo(map);
        })
        .catch(err=>console.error('Error cargando',file,err));
    }

    // Evento y carga inicial
    document.getElementById('variable-select')
            .addEventListener('change', loadData);
    loadData();

  </script>
</body>
</html>

